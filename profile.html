<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Student-Startup Connect</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
            color: #ecf0f1;
            min-height: 100vh;
        }
        .profile-container {
            max-width: 90%;
            margin: 0 auto;
            background: linear-gradient(145deg, #34495e, #2c3e50);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        .profile-container:hover {
            transform: translateY(-5px);
        }
        nav {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(90deg, #34495e 0%, #2c3e50 100%);
            padding: 15px 20px;
            transition: transform 0.3s ease;
            z-index: 1000;
            position: relative;
            border-bottom: none; /* Remove separation */
        }
        nav.hidden {
            transform: translateY(-100%);
        }
        .nav-logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1abc9c;
            margin-bottom: 10px;
        }
        .nav-links {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .nav-links a {
            color: #ecf0f1;
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
            width: 100%;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-links a:hover, .nav-links a:active {
            background-color: #1abc9c;
            color: #fff;
            transform: translateY(-2px);
        }
        .auth-buttons {
            width: 100%;
            display: flex;
            justify-content: center;
        }
        .auth-buttons button {
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: #fff;
            border: none;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 200px;
            min-height: 44px;
        }
        .auth-buttons button:hover, .auth-buttons button:active {
            background: linear-gradient(90deg, #c0392b, #e74c3c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        .profile-content {
            padding: 20px;
            background: inherit; /* Match the container's gradient */
            border-top: none; /* Remove separation */
        }
        .profile-header {
            text-align: center;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 2rem;
            margin: 0;
            background: linear-gradient(90deg, #1abc9c, #16a085);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, #1abc9c, #16a085) 1;
            padding-bottom: 10px;
            animation: fadeIn 1s ease-in-out;
        }
        .edit-profile-btn {
            margin-top: 15px;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            background: linear-gradient(90deg, #1abc9c, #16a085);
            color: #fff;
            border: none;
            transition: all 0.3s ease;
            display: inline-block;
            min-height: 44px;
            min-width: 150px;
        }
        .edit-profile-btn:hover, .edit-profile-btn:active {
            background: linear-gradient(90deg, #16a085, #1abc9c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 188, 156, 0.4);
        }
        h3, h4 {
            color: #1abc9c;
            margin: 0;
        }
        h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        h4 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        .subsection {
            margin-bottom: 15px;
        }
        .info-item {
            margin: 8px 0;
            padding: 10px;
            background-color: #3e5a74;
            border-radius: 8px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.3s ease;
            flex-wrap: wrap; /* Allow wrapping for long content */
            word-break: break-word; /* Break long words like emails */
            overflow-wrap: break-word; /* Ensure compatibility */
        }
        .info-item:hover {
            transform: translateX(5px);
        }
        .info-item i {
            color: #1abc9c;
            font-size: 1.1rem;
            flex-shrink: 0; /* Prevent icon from shrinking */
        }
        .info-item strong {
            color: #1abc9c;
            font-weight: 600;
            flex-shrink: 0; /* Prevent label from shrinking */
        }
        .info-item span, .info-item a {
            flex: 1; /* Allow content to take remaining space */
            word-break: break-word; /* Break long emails */
            overflow-wrap: break-word;
        }
        .confirmation-status {
            color: #e74c3c;
            font-style: italic;
            margin-top: 8px;
            font-size: 0.9rem;
            background: rgba(231, 76, 60, 0.1);
            padding: 10px;
            border-radius: 5px;
            word-break: break-word;
        }
        .card-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 10px;
        }
        .card {
            background: linear-gradient(145deg, #3e5a74, #34495e);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: #ecf0f1;
            text-align: left;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .card-content h4 {
            font-size: 1.4rem;
            margin: 0 0 8px;
            color: #1abc9c;
        }
        .card-content p {
            margin: 8px 0;
            line-height: 1.6;
            font-size: 0.9rem;
            color: #d1d8e0;
            word-break: break-word;
        }
        .project-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .project-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-height: 44px;
        }
        .delete-project {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: #fff;
        }
        .delete-project:hover, .delete-project:active {
            background: linear-gradient(90deg, #c0392b, #e74c3c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        .delete-project:disabled {
            background: #c0392b;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .project-list {
            list-style: none;
            padding: 0;
        }
        .project-item {
            background: linear-gradient(145deg, #3e5a74, #34495e);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.9rem;
            transition: transform 0.3s ease;
            word-break: break-word;
        }
        .project-item:hover {
            transform: translateY(-3px);
        }
        .project-item span {
            font-weight: 600;
            color: #1abc9c;
        }
        .project-item i {
            margin-right: 8px;
            color: #1abc9c;
        }
        .project-done, .project-remaining, .project-accept, .project-reject {
            padding: 8px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-height: 44px;
        }
        .project-done {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            color: #fff;
        }
        .project-done:hover, .project-done:active {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        .project-remaining {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            color: #fff;
        }
        .project-remaining:hover, .project-remaining:active {
            background: linear-gradient(90deg, #e67e22, #f39c12);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        .project-accept {
            background: linear-gradient(90deg, #1abc9c, #16a085);
            color: #fff;
        }
        .project-accept:hover, .project-accept:active {
            background: linear-gradient(90deg, #16a085, #1abc9c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 188, 156, 0.4);
        }
        .project-reject {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: #fff;
        }
        .project-reject:hover, .project-reject:active {
            background: linear-gradient(90deg, #c0392b, #e74c3c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        .project-actions {
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        .loading, .error {
            text-align: center;
            padding: 15px;
            font-size: 0.95rem;
            border-radius: 8px;
            word-break: break-word;
        }
        .loading {
            color: #1abc9c;
            background: rgba(26, 188, 156, 0.1);
        }
        .error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (min-width: 769px) {
            nav {
                flex-direction: row;
                padding: 15px 30px;
            }
            .nav-logo { margin-bottom: 0; }
            .nav-links {
                flex-direction: row;
                gap: 20px;
                margin-bottom: 0;
            }
            .nav-links a {
                font-size: 1.1rem;
                width: auto;
                min-height: auto;
            }
            .auth-buttons { width: auto; }
            .auth-buttons button {
                width: auto;
                max-width: none;
                padding: 10px 20px;
                font-size: 1rem;
                min-height: auto;
            }
            .profile-container { max-width: 900px; margin: 30px auto; }
            .profile-content { padding: 30px; }
            h2 { font-size: 2.5rem; margin-bottom: 20px; }
            .edit-profile-btn {
                padding: 10px 25px;
                font-size: 1rem;
                min-height: auto;
                min-width: 180px;
            }
            h3 { font-size: 1.8rem; margin-bottom: 15px; }
            h4 { font-size: 1.5rem; }
            .section { margin-bottom: 30px; padding: 20px; }
            .subsection { margin-bottom: 20px; }
            .info-item { margin: 10px 0; padding: 15px; font-size: 1.1rem; }
            .confirmation-status { font-size: 1rem; margin-top: 10px; }
            .card-container {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                padding: 20px;
            }
            .card { padding: 20px; }
            .card-content h4 { font-size: 1.6rem; margin-bottom: 10px; }
            .card-content p { font-size: 0.95rem; }
            .project-actions button {
                padding: 8px 15px;
                font-size: 0.9rem;
                min-height: auto;
            }
            .project-item {
                padding: 15px;
                margin-bottom: 15px;
                font-size: 1rem;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 0;
            }
            .project-actions {
                width: auto;
                gap: 10px;
            }
            .project-actions button {
                flex: none;
                padding: 8px 15px;
                font-size: 0.9rem;
                min-height: auto;
            }
            .loading, .error { padding: 20px; font-size: 1.1rem; }
        }

        @media (max-width: 768px) {
            nav { padding: 10px 15px; }
            .nav-logo { font-size: 1.4rem; margin-bottom: 8px; }
            .nav-links { gap: 8px; margin-bottom: 12px; }
            .nav-links a { font-size: 0.95rem; padding: 8px 15px; }
            .auth-buttons button {
                padding: 8px 15px;
                font-size: 0.9rem;
                max-width: 180px;
            }
            .profile-container { max-width: 95%; margin: 15px auto; }
            .profile-content { padding: 15px; }
            h2 { font-size: 1.8rem; margin-bottom: 15px; }
            .edit-profile-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
                min-width: 130px;
            }
            h3 { font-size: 1.4rem; margin-bottom: 8px; }
            h4 { font-size: 1.2rem; margin-bottom: 8px; }
            .section { margin-bottom: 15px; padding: 12px; }
            .subsection { margin-bottom: 12px; }
            .info-item { margin: 6px 0; padding: 8px; font-size: 0.9rem; gap: 8px; }
            .info-item i { font-size: 1rem; }
            .confirmation-status { font-size: 0.85rem; margin-top: 6px; padding: 8px; }
            .card-container { gap: 12px; padding: 8px; }
            .card { padding: 12px; }
            .card-content h4 { font-size: 1.3rem; margin-bottom: 6px; }
            .card-content p { font-size: 0.85rem; margin: 6px 0; }
            .project-actions { gap: 6px; }
            .project-actions button { padding: 6px 10px; font-size: 0.8rem; }
            .project-item { padding: 10px; margin-bottom: 8px; font-size: 0.85rem; gap: 8px; }
            .project-item i { margin-right: 6px; }
            .project-done, .project-remaining, .project-accept, .project-reject {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            .loading, .error { padding: 12px; font-size: 0.9rem; }
        }

        @media (max-width: 480px) {
            nav { padding: 8px 10px; }
            .nav-logo { font-size: 1.2rem; margin-bottom: 6px; }
            .nav-links { gap: 6px; margin-bottom: 10px; }
            .nav-links a { font-size: 0.9rem; padding: 6px 12px; }
            .auth-buttons button {
                padding: 6px 12px;
                font-size: 0.85rem;
                max-width: 160px;
            }
            .profile-container { margin: 10px auto; }
            .profile-content { padding: 12px; }
            h2 { font-size: 1.6rem; margin-bottom: 12px; }
            .edit-profile-btn {
                padding: 6px 12px;
                font-size: 0.85rem;
                min-width: 120px;
            }
            h3 { font-size: 1.3rem; margin-bottom: 6px; }
            h4 { font-size: 1.1rem; margin-bottom: 6px; }
            .section { margin-bottom: 12px; padding: 10px; }
            .subsection { margin-bottom: 10px; }
            .info-item { padding: 6px; font-size: 0.85rem; margin: 4px 0; gap: 6px; }
            .info-item i { font-size: 0.9rem; }
            .confirmation-status { font-size: 0.8rem; margin-top: 4px; padding: 6px; }
            .card { padding: 10px; }
            .card-content h4 { font-size: 1.2rem; margin-bottom: 4px; }
            .card-content p { font-size: 0.8rem; margin: 4px 0; }
            .project-actions button { padding: 5px 8px; font-size: 0.75rem; }
            .project-item { padding: 8px; font-size: 0.8rem; gap: 6px; }
            .project-done, .project-remaining, .project-accept, .project-reject {
                padding: 5px 8px;
                font-size: 0.75rem;
            }
            .loading, .error { padding: 10px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <nav id="navbar">
            <div class="nav-logo">Student-Startup Connect</div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="available-projects.html">Available Projects</a>
                <a href="available-students.html">Available Students</a>
                <a href="community.html">Community Forum</a>
            </div>
            <div class="auth-buttons">
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </nav>
        <div class="profile-content">
            <div class="profile-header">
                <h2>Profile</h2>
                <button class="edit-profile-btn" id="editProfileBtn">Edit Profile</button>
            </div>
            <div class="section" id="personalInfo">
                <h3 id="infoTitle"></h3>
                <div id="infoDetails" class="loading">Loading profile...</div>
            </div>
            <div class="section" id="pastProjects" style="display: none;">
                <h3>Past Projects</h3>
                <ul id="pastProjectsList" class="project-list"></ul>
            </div>
            <div class="section" id="currentProjects" style="display: none;">
                <h3>Current Projects</h3>
                <ul id="currentProjectsList" class="project-list"></ul>
            </div>
            <div class="section" id="appliedProjects" style="display: none;">
                <h3>Applied Projects</h3>
                <ul id="appliedProjectsList" class="project-list"></ul>
            </div>
            <div class="section" id="uploadedProjects" style="display: none;">
                <h3>Uploaded Projects</h3>
                <div class="subsection" id="confirmedProjects">
                    <h4>Confirmed Projects</h4>
                    <div id="confirmedProjectsList" class="card-container"></div>
                </div>
                <div class="subsection" id="inProgressProjects">
                    <h4>In Progress Projects</h4>
                    <div id="inProgressProjectsList" class="card-container"></div>
                </div>
                <div class="subsection" id="doneProjects">
                    <h4>Done Projects</h4>
                    <div id="doneProjectsList" class="card-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, get, update, set, remove, push } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD0wtET8bTtw_133RE4rWZiRFGESfbDtC0",
            authDomain: "student-startup-connect.firebaseapp.com",
            databaseURL: "https://student-startup-connect-default-rtdb.firebaseio.com",
            projectId: "student-startup-connect",
            storageBucket: "student-startup-connect.firebasestorage.app",
            messagingSenderId: "570854385529",
            appId: "1:570854385529:web:e45e5076a0cbcb9a56f1a8",
            measurementId: "G-T5PMGL8K26"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const database = getDatabase(app);

            console.log("Firebase initialized successfully");

            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    alert("Please log in to view your profile.");
                    window.location.href = 'login.html';
                    return;
                }

                const userId = localStorage.getItem('userId');
                const userType = localStorage.getItem('userType');

                if (!userId || !userType) {
                    alert("User session not found. Please log in again.");
                    window.location.href = 'login.html';
                    return;
                }

                console.log("User authenticated:", { userId, userType });

                const userRef = ref(database, `users/${userId}`);
                get(userRef).then((snapshot) => {
                    if (!snapshot.exists()) {
                        document.getElementById('infoDetails').innerHTML = '<div class="error">User data not found. Please sign up again.</div>';
                        return;
                    }

                    const userData = snapshot.val();
                    const isConfirmed = userData.confirmed === true;
                    localStorage.setItem('isConfirmed', isConfirmed.toString());

                    console.log("User data loaded:", { userData, isConfirmed });

                    const infoTitle = document.getElementById('infoTitle');
                    const infoDetails = document.getElementById('infoDetails');

                    if (userType === 'student') {
                        infoTitle.textContent = "Personal Information";
                        infoDetails.innerHTML = `
                            <div class="info-item"><i class="fas fa-user"></i><strong>First Name:</strong> <span>${userData.firstName || 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-user"></i><strong>Last Name:</strong> <span>${userData.lastName || 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-envelope"></i><strong>Email:</strong> <span>${userData.email || 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-tools"></i><strong>Skills:</strong> <span>${userData.skills ? userData.skills.join(', ') : 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-graduation-cap"></i><strong>Education:</strong> <span>${userData.education || 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-link"></i><strong>Portfolio:</strong> <span>${userData.portfolio ? `<a href="${userData.portfolio}" target="_blank">${userData.portfolio}</a>` : 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-check-circle"></i><strong>Confirmation Status:</strong> <span>${isConfirmed ? 'Confirmed' : 'Unconfirmed'}</span></div>
                            ${!isConfirmed ? '<p class="confirmation-status">Note: You cannot apply to projects until your profile is confirmed by the host.</p>' : ''}
                        `;

                        document.getElementById('pastProjects').style.display = 'block';
                        document.getElementById('currentProjects').style.display = 'block';
                        document.getElementById('appliedProjects').style.display = 'block';

                        const pastProjectsRef = ref(database, `users/${userId}/pastProjects`);
                        get(pastProjectsRef).then(async (snapshot) => {
                            const pastProjectsList = document.getElementById('pastProjectsList');
                            pastProjectsList.innerHTML = '';
                            if (snapshot.exists()) {
                                const projects = snapshot.val();
                                if (Object.keys(projects).length > 0) {
                                    for (const projectId of Object.keys(projects)) {
                                        const project = projects[projectId];
                                        const projectRef = ref(database, `projects/${projectId}`);
                                        const projectSnapshot = await get(projectRef);
                                        let completedTimestamp = null;
                                        if (projectSnapshot.exists()) {
                                            const projectData = projectSnapshot.val();
                                            completedTimestamp = projectData.completedTimestamp || null;
                                        }

                                        const li = document.createElement('li');
                                        li.className = 'project-item';
                                        let buttonHtml = '';
                                        if (completedTimestamp) {
                                            const timeSinceCompleted = Date.now() - completedTimestamp;
                                            const hoursSinceCompleted = timeSinceCompleted / (1000 * 60 * 60);
                                            if (hoursSinceCompleted <= 36) {
                                                buttonHtml = `
                                                    <div class="project-actions">
                                                        <button class="project-remaining" data-project-id="${projectId}">Remaining</button>
                                                    </div>
                                                `;
                                            }
                                        }
                                        li.innerHTML = `
                                            <div>
                                                <i class="fas fa-history"></i>
                                                <span>${project.title}</span> - ${project.description}
                                            </div>
                                            ${buttonHtml}
                                        `;
                                        pastProjectsList.appendChild(li);

                                        const remainingButton = li.querySelector('.project-remaining');
                                        if (remainingButton) {
                                            remainingButton.addEventListener('click', async () => {
                                                try {
                                                    const projectRef = ref(database, `projects/${projectId}`);
                                                    await update(projectRef, { 
                                                        status: 'Open',
                                                        completedTimestamp: null
                                                    });
                                                    const currentProjectRef = ref(database, `users/${userId}/currentProjects/${projectId}`);
                                                    await set(currentProjectRef, {
                                                        title: project.title,
                                                        description: project.description,
                                                        studentAccepted: true
                                                    });
                                                    const applicationsRef = ref(database, `applications`);
                                                    const newAppRef = push(applicationsRef);
                                                    await set(newAppRef, {
                                                        projectId: projectId,
                                                        studentId: userId,
                                                        fullName: `${userData.firstName} ${userData.lastName}`,
                                                        email: userData.email,
                                                        resumeLink: userData.resume || '',
                                                        githubLink: userData.github || '',
                                                        linkedinLink: userData.linkedin || '',
                                                        coverLetter: 'Reinstated application after marking as remaining',
                                                        additionalInfo: '',
                                                        status: 'Accepted',
                                                        timestamp: Date.now()
                                                    });
                                                    const pastProjectRef = ref(database, `users/${userId}/pastProjects/${projectId}`);
                                                    await remove(pastProjectRef);
                                                    alert('Project moved back to current projects!');
                                                    window.location.reload();
                                                } catch (error) {
                                                    console.error('Error moving project to current:', error);
                                                    alert('Error moving project to current: ' + error.message);
                                                }
                                            });
                                        }
                                    }
                                } else {
                                    pastProjectsList.innerHTML = '<li>No past projects found.</li>';
                                }
                            } else {
                                pastProjectsList.innerHTML = '<li>No past projects found.</li>';
                            }
                        }).catch((error) => {
                            console.error('Error loading past projects:', error);
                            document.getElementById('pastProjectsList').innerHTML = '<li class="error">Error loading past projects: ' + error.message + '</li>';
                        });

                        const currentProjectsRef = ref(database, `users/${userId}/currentProjects`);
                        get(currentProjectsRef).then((snapshot) => {
                            const currentProjectsList = document.getElementById('currentProjectsList');
                            currentProjectsList.innerHTML = '';
                            if (snapshot.exists()) {
                                const projects = snapshot.val();
                                if (Object.keys(projects).length > 0) {
                                    Object.keys(projects).forEach((projectId) => {
                                        const project = projects[projectId];
                                        const li = document.createElement('li');
                                        li.className = 'project-item';
                                        let buttonHtml = '';
                                        if (project.studentAccepted) {
                                            buttonHtml = `
                                                <div class="project-actions">
                                                    <button class="project-done" data-project-id="${projectId}">Done</button>
                                                </div>
                                            `;
                                        } else {
                                            buttonHtml = `
                                                <div class="project-actions">
                                                    <button class="project-accept" data-project-id="${projectId}">Accept</button>
                                                    <button class="project-reject" data-project-id="${projectId}">Reject</button>
                                                </div>
                                            `;
                                        }
                                        li.innerHTML = `
                                            <div>
                                                <i class="fas fa-tasks"></i>
                                                <span>${project.title}</span> - ${project.description}
                                            </div>
                                            ${buttonHtml}
                                        `;
                                        currentProjectsList.appendChild(li);

                                        const doneButton = li.querySelector('.project-done');
                                        if (doneButton) {
                                            doneButton.addEventListener('click', async () => {
                                                try {
                                                    const projectRef = ref(database, `projects/${projectId}`);
                                                    await update(projectRef, { 
                                                        status: 'Completed',
                                                        completedTimestamp: Date.now()
                                                    });
                                                    const pastProjectRef = ref(database, `users/${userId}/pastProjects/${projectId}`);
                                                    await set(pastProjectRef, {
                                                        title: project.title,
                                                        description: project.description
                                                    });
                                                    const currentProjectRef = ref(database, `users/${userId}/currentProjects/${projectId}`);
                                                    await remove(currentProjectRef);
                                                    const applicationsRef = ref(database, `applications`);
                                                    const snapshot = await get(applicationsRef);
                                                    if (snapshot.exists()) {
                                                        const applications = snapshot.val();
                                                        const projectApps = Object.entries(applications).filter(([_, app]) => 
                                                            app.projectId === projectId && app.studentId === userId);
                                                        for (const [appId, _] of projectApps) {
                                                            await remove(ref(database, `applications/${appId}`));
                                                        }
                                                    }
                                                    alert('Project marked as completed!');
                                                    window.location.reload();
                                                } catch (error) {
                                                    console.error('Error marking project as completed:', error);
                                                    alert('Error marking project as completed: ' + error.message);
                                                }
                                            });
                                        }

                                        const acceptButton = li.querySelector('.project-accept');
                                        if (acceptButton) {
                                            acceptButton.addEventListener('click', async () => {
                                                try {
                                                    const currentProjectRef = ref(database, `users/${userId}/currentProjects/${projectId}`);
                                                    await update(currentProjectRef, { studentAccepted: true });
                                                    alert('Project accepted!');
                                                    window.location.reload();
                                                } catch (error) {
                                                    console.error('Error accepting project:', error);
                                                    alert('Error accepting project: ' + error.message);
                                                }
                                            });
                                        }

                                        const rejectButton = li.querySelector('.project-reject');
                                        if (rejectButton) {
                                            rejectButton.addEventListener('click', async () => {
                                                try {
                                                    const applicationsRef = ref(database, `applications`);
                                                    const snapshot = await get(applicationsRef);
                                                    if (snapshot.exists()) {
                                                        const applications = snapshot.val();
                                                        const projectApps = Object.entries(applications).filter(([_, app]) => 
                                                            app.projectId === projectId && app.studentId === userId && app.status === 'Accepted');
                                                        for (const [appId, _] of projectApps) {
                                                            await update(ref(database, `applications/${appId}`), { status: 'Pending' });
                                                        }
                                                    }
                                                    const currentProjectRef = ref(database, `users/${userId}/currentProjects/${projectId}`);
                                                    await remove(currentProjectRef);
                                                    alert('Project rejected!');
                                                    window.location.reload();
                                                } catch (error) {
                                                    console.error('Error rejecting project:', error);
                                                    alert('Error rejecting project: ' + error.message);
                                                }
                                            });
                                        }
                                    });
                                } else {
                                    currentProjectsList.innerHTML = '<li>No current projects found.</li>';
                                }
                            } else {
                                currentProjectsList.innerHTML = '<li>No current projects found.</li>';
                            }
                        }).catch((error) => {
                            console.error('Error loading current projects:', error);
                            document.getElementById('currentProjectsList').innerHTML = '<li class="error">Error loading current projects: ' + error.message + '</li>';
                        });

                        const applicationsRef = ref(database, `applications`);
                        get(applicationsRef).then(async (snapshot) => {
                            const appliedProjectsList = document.getElementById('appliedProjectsList');
                            appliedProjectsList.innerHTML = '';
                            if (snapshot.exists()) {
                                const applications = snapshot.val();
                                const userApplications = Object.values(applications).filter(app => app.studentId === userId);
                                if (userApplications.length > 0) {
                                    const projectPromises = userApplications.map(async (app) => {
                                        const projectRef = ref(database, `projects/${app.projectId}`);
                                        const projectSnapshot = await get(projectRef);
                                        if (projectSnapshot.exists()) {
                                            const project = projectSnapshot.val();
                                            if (project.status !== 'Completed') {
                                                return { project, status: app.status };
                                            }
                                        }
                                        return null;
                                    });

                                    const projectResults = await Promise.all(projectPromises);
                                    const validProjects = projectResults.filter(result => result !== null);

                                    if (validProjects.length > 0) {
                                        validProjects.forEach(({ project, status }) => {
                                            const li = document.createElement('li');
                                            li.className = 'project-item';
                                            li.innerHTML = `
                                                <div>
                                                    <i class="fas fa-file-alt"></i>
                                                    <span>${project.projectTitle}</span> - ${project.description} (Status: ${status})
                                                </div>
                                            `;
                                            appliedProjectsList.appendChild(li);
                                        });
                                    } else {
                                        appliedProjectsList.innerHTML = '<li>No applied projects found.</li>';
                                    }
                                } else {
                                    appliedProjectsList.innerHTML = '<li>No applied projects found.</li>';
                                }
                            } else {
                                appliedProjectsList.innerHTML = '<li>No applied projects found.</li>';
                            }
                        }).catch((error) => {
                            console.error('Error loading applied projects:', error);
                            document.getElementById('appliedProjectsList').innerHTML = '<li class="error">Error loading applied projects: ' + error.message + '</li>';
                        });

                    } else if (userType === 'startup') {
                        infoTitle.textContent = "Company Details";
                        infoDetails.innerHTML = `
                            <div class="info-item"><i class="fas fa-building"></i><strong>Company Name:</strong> <span>${userData.companyName || 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-info-circle"></i><strong>Description:</strong> <span>${userData.companyDescription || 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-industry"></i><strong>Industry:</strong> <span>${userData.industry || 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-globe"></i><strong>Website:</strong> <span>${userData.website ? `<a href="${userData.website}" target="_blank">${userData.website}</a>` : 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-map-marker-alt"></i><strong>Location:</strong> <span>${userData.location || 'Not provided'}</span></div>
                            <div class="info-item"><i class="fas fa-envelope"></i><strong>Email:</strong> <span>${userData.email || 'Not provided'}</span></div>
                        `;

                        document.getElementById('uploadedProjects').style.display = 'block';

                        const projectsRef = ref(database, 'projects');
                        const applicationsRef = ref(database, 'applications');

                        Promise.all([
                            get(projectsRef),
                            get(applicationsRef)
                        ]).then(async ([projectsSnapshot, applicationsSnapshot]) => {
                            const confirmedProjectsList = document.getElementById('confirmedProjectsList');
                            const inProgressProjectsList = document.getElementById('inProgressProjectsList');
                            const doneProjectsList = document.getElementById('doneProjectsList');

                            confirmedProjectsList.innerHTML = '';
                            inProgressProjectsList.innerHTML = '';
                            doneProjectsList.innerHTML = '';

                            let allProjects = {};
                            let allApplications = {};

                            if (projectsSnapshot.exists()) {
                                allProjects = projectsSnapshot.val();
                            } else {
                                confirmedProjectsList.innerHTML = '<p>No confirmed projects available.</p>';
                                inProgressProjectsList.innerHTML = '<p>No in-progress projects available.</p>';
                                doneProjectsList.innerHTML = '<p>No completed projects available.</p>';
                                return;
                            }

                            if (applicationsSnapshot.exists()) {
                                allApplications = applicationsSnapshot.val();
                            } else {
                                allApplications = {};
                            }

                            const userProjects = Object.entries(allProjects).filter(([_, project]) => project.postedBy === userId);

                            if (userProjects.length === 0) {
                                confirmedProjectsList.innerHTML = '<p>No confirmed projects available.</p>';
                                inProgressProjectsList.innerHTML = '<p>No in-progress projects available.</p>';
                                doneProjectsList.innerHTML = '<p>No completed projects available.</p>';
                                return;
                            }

                            const confirmedProjects = [];
                            const inProgressProjects = [];
                            const doneProjects = [];

                            for (const [projectId, project] of userProjects) {
                                if (project.status === 'Completed') {
                                    doneProjects.push([projectId, project]);
                                } else if (project.status === 'In Progress') {
                                    inProgressProjects.push([projectId, project]);
                                } else {
                                    const isAccepted = await hasAcceptedApplications(projectId, allApplications);
                                    if (isAccepted) {
                                        inProgressProjects.push([projectId, project]);
                                    } else if (project.confirmed === true && project.status === 'Open') {
                                        confirmedProjects.push([projectId, project]);
                                    }
                                }
                            }

                            if (confirmedProjects.length === 0) {
                                confirmedProjectsList.innerHTML = '<p>No confirmed projects available.</p>';
                            } else {
                                confirmedProjects.forEach(([projectId, project]) => {
                                    renderProjectCard(projectId, project, confirmedProjectsList, 'Confirmed');
                                });
                            }

                            if (inProgressProjects.length === 0) {
                                inProgressProjectsList.innerHTML = '<p>No in-progress projects available.</p>';
                            } else {
                                inProgressProjects.forEach(([projectId, project]) => {
                                    renderProjectCard(projectId, project, inProgressProjectsList, 'In Progress');
                                });
                            }

                            if (doneProjects.length === 0) {
                                doneProjectsList.innerHTML = '<p>No completed projects available.</p>';
                            } else {
                                doneProjects.forEach(([projectId, project]) => {
                                    renderProjectCard(projectId, project, doneProjectsList, 'Done');
                                });
                            }
                        }).catch((error) => {
                            console.error('Error loading uploaded projects:', error);
                            document.getElementById('confirmedProjectsList').innerHTML = '<p class="error">Error loading projects: ' + error.message + '</p>';
                            document.getElementById('inProgressProjectsList').innerHTML = '<p class="error">Error loading projects: ' + error.message + '</p>';
                            document.getElementById('doneProjectsList').innerHTML = '<p class="error">Error loading projects: ' + error.message + '</p>';
                        });
                    } else {
                        document.getElementById('infoDetails').innerHTML = '<div class="error">Invalid user type. Please sign up again.</div>';
                    }
                }).catch((error) => {
                    console.error('Error loading profile:', error);
                    document.getElementById('infoDetails').innerHTML = '<div class="error">Error loading profile data: ' + error.message + '</div>';
                });

                document.getElementById('editProfileBtn').addEventListener('click', () => {
                    window.location.href = 'student-form.html';
                });
            });

            async function hasAcceptedApplications(projectId, applications) {
                if (!applications || Object.keys(applications).length === 0) return false;
                const projectApps = Object.values(applications).filter(app => app.projectId === projectId && app.status === 'Accepted');
                if (projectApps.length === 0) return false;
                for (const app of projectApps) {
                    const studentProjectRef = ref(database, `users/${app.studentId}/currentProjects/${projectId}`);
                    const snapshot = await get(studentProjectRef);
                    if (snapshot.exists() && snapshot.val().studentAccepted === true) return true;
                }
                return false;
            }

            function renderProjectCard(projectId, project, container, status) {
                const projectCard = document.createElement('div');
                projectCard.className = 'card';
                projectCard.innerHTML = `
                    <div class="card-content">
                        <h4>${project.projectTitle || 'Untitled Project'}</h4>
                        <p>${project.description || 'No description available'}</p>
                        <p><strong>Skills Required:</strong> ${project.skills || 'Not specified'}</p>
                        <p><strong>Duration:</strong> ${project.duration || 'Not specified'}</p>
                        <p><strong>Startup:</strong> ${project.startup || 'Not specified'}</p>
                        <p><strong>Compensation:</strong> ${project.compensation || 'Not specified'}</p>
                        <p><strong>Status:</strong> ${status}</p>
                        <div class="project-actions">
                            <button class="delete-project" id="delete-project-${projectId}">Delete Project</button>
                        </div>
                    </div>
                `;

                const deleteProjectButton = projectCard.querySelector(`#delete-project-${projectId}`);
                if (deleteProjectButton) {
                    deleteProjectButton.disabled = false;
                    deleteProjectButton.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (confirm('Are you sure you want to delete this project? This will also delete all associated applications.')) {
                            try {
                                await remove(ref(database, `projects/${projectId}`));
                                const applicationsRef = ref(database, `applications`);
                                const snapshot = await get(applicationsRef);
                                if (snapshot.exists()) {
                                    const applications = snapshot.val();
                                    const projectApps = Object.entries(applications).filter(([_, app]) => app.projectId === projectId);
                                    for (const [appId, _] of projectApps) {
                                        await remove(ref(database, `applications/${appId}`));
                                    }
                                }
                                const applicationsSnapshot = await get(applicationsRef);
                                let studentsWithProject = [];
                                if (applicationsSnapshot.exists()) {
                                    const applications = applicationsSnapshot.val();
                                    studentsWithProject = Object.entries(applications)
                                        .filter(([_, app]) => app.projectId === projectId && app.status === 'Accepted')
                                        .map(([_, app]) => app.studentId);
                                }
                                for (const studentId of studentsWithProject) {
                                    await remove(ref(database, `users/${studentId}/currentProjects/${projectId}`));
                                }
                                alert('Project deleted successfully!');
                                window.location.reload();
                            } catch (error) {
                                console.error('Error deleting project:', error);
                                alert('Error deleting project: ' + error.message);
                            }
                        }
                    });
                }
                container.appendChild(projectCard);
            }

            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    localStorage.removeItem('userType');
                    localStorage.removeItem('userId');
                    localStorage.removeItem('isConfirmed');
                    alert('Logged out successfully!');
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out: ' + error.message);
                }
            });

            let lastScrollTop = 0;
            const navbar = document.getElementById('navbar');
            window.addEventListener('scroll', () => {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollTop > lastScrollTop) {
                    navbar.classList.add('hidden');
                } else {
                    navbar.classList.remove('hidden');
                }
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            });
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            alert('Error initializing Firebase: ' + error.message);
        }
    </script>
</body>
</html>
